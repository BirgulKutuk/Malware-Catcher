package com.malware.catcher.service;

import com.malware.catcher.dto.DetectorResponseDto;
import com.malware.catcher.model.DetectionData;
import com.malware.catcher.model.DeviceData;
import com.malware.catcher.model.EnumDetectionTypes;
import com.malware.catcher.model.EnumDeviceType;
import com.malware.catcher.repository.DetectionDataRepository;
import com.malware.catcher.repository.DeviceDataRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@Service
public class DetectorService {

    private static final Logger logger = LoggerFactory.getLogger(DetectorService.class);

    @Autowired
    DeviceDataRepository deviceDataRepository;

    @Autowired
    DetectionDataRepository detectionDataRepository;

    public void detectAndStoreMalware(DeviceData deviceData, List<DetectionData> detectionDataList) throws Exception {

        try {
            validateDetectorRequestData(deviceData, detectionDataList);
        } catch (Exception e) {
            logger.error("Invalid request data detected !");
            throw e;
        }

        try {
            deviceDataRepository.save(deviceData);
            for (DetectionData detectionData : detectionDataList) {
                detectionDataRepository.save(detectionData);
            }
        } catch (Exception e) {
            logger.error("Exception occured while storing detection data !");
            throw e;
        }
    }

    private void validateDetectorRequestData(DeviceData deviceData, List<DetectionData> detectionDataList) throws Exception {

        validateDeviceData(deviceData);

        for (DetectionData detectionData : detectionDataList) {
            setDetectionType(detectionData);
            validateDetectionData(detectionData);
        }
    }

    private void validateDeviceData(DeviceData deviceData) throws Exception {

        if (deviceData == null) {
            throw new Exception("DeviceData can not be null.");
        } else if (StringUtils.isEmpty(deviceData.getDeviceUUID()) ||
                StringUtils.isEmpty(deviceData.getDeviceType()) ||
                StringUtils.isEmpty(deviceData.getDeviceModel()) ||
                StringUtils.isEmpty(deviceData.getDeviceOsVersion())) {
            throw new Exception("DeviceUUID, DeviceType, DeviceModel, and DeviceOsVersion are mandatory. All have to be filled.");
        } else if (!EnumDeviceType.WEB.text.equals(deviceData.getDeviceType()) &&
                !EnumDeviceType.ANDROID.text.equals(deviceData.getDeviceType()) &&
                !EnumDeviceType.IOS.text.equals(deviceData.getDeviceType())) {
            throw new Exception("DeviceType can only be WEB, ANDROID, or IOS.");
        }
    }

    private void validateDetectionData(DetectionData detectionData) throws Exception {

        if (!EnumDetectionTypes.NEW_DETECTION.text.equals(detectionData.getDetectionType()) &&
                !EnumDetectionTypes.RESOLVED_DETECTION.text.equals(detectionData.getDetectionType()) &&
                !EnumDetectionTypes.NO_DETECTION.text.equals(detectionData.getDetectionType())) {
            throw new Exception("DetectionType can only be NEW_DETECTION, RESOLVED_DETECTION, or NO_DETECTION.");
        }
    }

    private void setDetectionType(DetectionData detectionData) throws Exception {

        if (detectionData == null) {
            throw new Exception("DetectionData can not be null.");
        }

        if (!StringUtils.isEmpty(detectionData.getDetectionId()) &&
                !StringUtils.isEmpty(detectionData.getDetectionTime()) &&
                !StringUtils.isEmpty(detectionData.getDetectionAppName()) &&
                !StringUtils.isEmpty(detectionData.getDetectionAppType())) {
            detectionData.setDetectionType(EnumDetectionTypes.NEW_DETECTION.name());
        } else if (!StringUtils.isEmpty(detectionData.getDetectionId()) &&
                !StringUtils.isEmpty(detectionData.getDetectionTime())) {
            detectionData.setDetectionType(EnumDetectionTypes.RESOLVED_DETECTION.name());
        } else if (!StringUtils.isEmpty(detectionData.getDetectionTime())) {
            detectionData.setDetectionType(EnumDetectionTypes.NO_DETECTION.name());
        }
    }

}
