package com.malware.catcher.controller;

import com.github.dozermapper.core.DozerBeanMapperBuilder;
import com.github.dozermapper.core.Mapper;
import com.malware.catcher.dto.DetectionDataDto;
import com.malware.catcher.dto.DetectorRequestDto;
import com.malware.catcher.dto.DetectorResponseDto;
import com.malware.catcher.model.DetectionData;
import com.malware.catcher.model.DeviceData;
import com.malware.catcher.service.DetectorService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@RestController
public class DetectorRestController {

    private static final Logger logger = LoggerFactory.getLogger(DetectorRestController.class);

    @Autowired
    DetectorService detectorService;

    @PostMapping("/store")
    public ResponseEntity<DetectorResponseDto> detectAndStoreMalware(@RequestBody DetectorRequestDto detectorRequest) throws Exception {

        List<DetectionData> detectionDataList = new ArrayList<>();
        DetectionData detectionData;

        try {
            Mapper dozerMapper = DozerBeanMapperBuilder.create().withMappingFiles("dozer-mapper.xml").build();

            DeviceData deviceData = dozerMapper.map(detectorRequest.getDeviceData(), DeviceData.class);

            for (DetectionDataDto detectionDataDto : detectorRequest.getDetectionDataList()) {
                detectionData = dozerMapper.map(detectionDataDto, DetectionData.class);
                detectionData.setDeviceData(deviceData);
                detectionDataList.add(detectionData);
            }

            deviceData.setDetectionDataList(detectionDataList);

            detectorService.detectAndStoreMalware(deviceData, detectionDataList);
        } catch (Exception e) {
            logger.error(e.getLocalizedMessage());
            throw e;
        }

        return new ResponseEntity(HttpStatus.OK);
    }

    @GetMapping("/retrieve")
    public ResponseEntity<List<DetectorResponseDto>> retrieveMalwares(
            @RequestParam(value = "deviceUUID", required = false) UUID deviceUUID,
            @RequestParam(value = "deviceType", required = false) String deviceType,
            @RequestParam(value = "deviceModel", required = false) String deviceModel,
            @RequestParam(value = "deviceOsVersion", required = false) String deviceOsVersion,
            @RequestParam(value = "detectionAppName", required = false) String detectionAppName,
            @RequestParam(value = "detectionType", required = false) String detectionType) {

        List<DetectorResponseDto> detectorResponseDtoList = new ArrayList<>();
        try {
            detectorResponseDtoList = detectorService.retrieveMalwares(
                    deviceUUID, deviceType, deviceModel, deviceOsVersion, detectionAppName, detectionType);
        } catch (Exception e) {
            logger.error(e.getLocalizedMessage());
            throw e;
        }

        return new ResponseEntity<>(detectorResponseDtoList, HttpStatus.OK);
    }

}
